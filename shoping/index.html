<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>ds</title>

    <link href="css/select.css" rel="stylesheet" />
    <script src="js/jquery.min.js"></script>
    <script src="js/pro.js"></script>
 
    <link href="css/all.css" rel="stylesheet" />
    <script src="js/jquery.easing.js" type="text/javascript"></script>
    <script src="js/studio.js" type="text/javascript"></script>
    <link href="css/common.css" rel="stylesheet" />
    <link href="css/animate.min.css" rel="stylesheet" />
    <script src="js/jquery.linq.min.js"></script>
    <script src="js/linq.min.js"></script>
    <script src="js/jquery.fbmodel.js"></script>
    <link href="css/fbmodal.css" rel="stylesheet" />
    <style>
        .asxsyd92 p{  width: 604px;
    /*background: #eaeaea;*/
    /* height: 55px; */
    line-height: 30px;
    margin-top: 10px;
    padding: 0 18px;
    font-size: 14pt;
        }
        .asxsyd92 input {
              width: 55%;
    padding: 0px;
    margin-left: 20px;
    color: #999;
    border: solid 1px #eaeaea;
    margin-top: -5px;
    font-size: 14pt;
        }
    </style>
</head>

<body>
    <div class="tops" hidden><p style="line-height:2;text-indent:1.2em;">亲，选择你所需要的展具加入购物车，加入之后点击底部的购物车就可以提交预订啦！ </p></div>

    <div class="test"><p style="line-height:2;text-indent:1.2em;" id="shop">  </p>
        <div class="asxsyd92">
            <p>单位<input type="text" id="CustomerName" name="CustomerName" class="name" value="输入您的所在单位" /></p>
            <p>姓名<input type="text" id="Contacts" name="Contacts" class="name" value="输入您的姓名" /></p>
            <p>手机<input type="text" id="Phone" name="Phone" class="mobile" value="输入您的手机号" /></p>
            <p>Q&nbsp;Q<input type="text" id="QQ" name="QQ" class="name" value="输入您的QQ方便联系" /></p>
            <p>展位<input type="text" id="Position" name="Position" class="name" value="你要哪个展位呢？" /></p>
        </div>
    </div>

    <div id="HBox">
        <form action="" method="post" onsubmit="return false;">
            <ul class="list" id="goods">
                <li>
                    <strong>数 量 <font color="#ff0000">*</font></strong>
                    <div class="fl"><input type="text" name="count" value="" class="ipt nickname" />
                        <input type="text" id="KeyId" name="KeyId" value="" class="KeyId" hidden />
                    </div>
                </li>
                <li><input type="button" value="确认填加" class="submitBtn" /></li>
            </ul>
        </form>
    </div><!-- HBox end -->
    <div id="portfolio" class="sel_portfolio">
        <!-- container -->
        <div class="container">
            <div class="main">
                <!--ps_box-->
                <div class="ps_box">
                    <div class="pics_switch">
                        <div class="pb">
                            <div class="pic_box"><a class="pic_banner_001" target="_blank" href="#"></a></div>
                            <div class="pic_box"><a class="pic_banner_002" target="_blank" href="#"></a></div>
                            <div class="pic_box"><a class="pic_banner_003" target="_blank" href="#"></a></div>
                            <div class="pic_box"><a class="pic_banner_004" target="_blank" href="#"></a></div>
                        </div>
                        <div class="viewArrows prev">上一张</div>
                        <div class="viewArrows next">下一张</div>
                        <div class="pics_switch_clients">
                            <ul>
                                <li class="li_1"><span class="current">1</span></li>
                                <li class="li_2"><span>2</span></li>
                                <li class="li_3"><span>3</span></li>
                                <li class="li_4"><span>4</span></li>
                            </ul>
                        </div>
                    </div>
                </div>
                <!--case_box-->
            </div>
        </div>

    </div>
    <div id="M-main-b">
    </div>
    <div class="J-shoping J-shoping-small">
        <div class="J-shoping-item">
          
            <div class="baseBg J-L-ico J-shoping-pos"></div>
            <div class="J-shoping-main">
                <div class="J-shoping-title">
                    <a href="javascript:buy()" style="color:#ffffff" title=""><em class="baseBg"></em>购物车</a>
                    <span class="baseBg J-shoping-num">0</span>
                </div>
                <!--<div class="baseBg J-shoping-mx"></div>
                <div class="J-shoping-px"></div>
                <div class="J-shoping-body">
                    <div class="J-shoping-buy">
                        <span>最多显示最新<strong>5</strong>条</span>
                        <a class="baseBg" href="http://sc.chinaz.com/" title="去购物车结算"></a>
                    </div>
                </div>-->
            </div>
            <div class="baseBg J-R-ico J-shoping-pos" id="db"></div>
        </div>
    </div>



    <script src="js/jquery.hDialog.min.js"></script>
 
    <script type="text/javascript">
        $(function () {
           // ExhibitionData.init();//初始化
          //  ExhibitionData.createDatabase();
            var $el = $('.dialog');
            $el.hDialog();
});

        function Add(id) {
            sessionStorage.setItem("key", id);
   $(".test").hDialog({
        box: '#HBox',
        effect: 'zoomInDown'
   });
}
//提交并验证表单
$('.submitBtn').click(function () {
    var EmailReg = /^\w+([-+.]\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*$/; //邮件正则
    var PhoneReg = /^0{0,1}(13[0-9]|15[0-9]|153|156|18[7-9])[0-9]{8}$/; //手机正则
    var $nickname = $('.nickname');
    var $KeyId = $('.KeyId');
    var $phone = $('.phone');
    if ($nickname.val() == '') {
        $.tooltip('数量还没填呢...'); $nickname.focus();
    } else {
        // var count = $("#countNum").val();
        var id = sessionStorage.getItem("key");
        //  this.query = function () {
        ExhibitionData.dataBase.transaction(function (tx) {
            tx.executeSql(
            "select * from exhibition where KeyId=?", [id],
            function (tx, result) { //执行成功的回调函数
                if (result.rows.length > 0) {
                    //成功 
                    $.tooltip('亲 失败了！你已经填加到购物车或已订购！', 2000, true);
                    alert('亲 失败了！你已经填加到购物车或已订购！');
                    //new TipBox({ type: 'success', str: "亲 ，你已经填加到购物车了哟！", hasBtn: true });
                   // ExhibitionData.getAll();
                } else {
                    ExhibitionData.dataBase.transaction(function (tx) {
                        tx.executeSql(
                        "insert into exhibition (KeyId,count,state) values(?,?,?)",
                        [id, $nickname.val(), 1],
                        function () {
                            alert("亲 ，填加成功！");
                           // new TipBox({ type: 'success', str: "亲 ，填加成功！", hasBtn: true });
                        },
                        function (tx, error) {
                            alert("亲 ，填加失败！");
                            //new TipBox({ type: 'success', str: "亲 ，填加失败！", hasBtn: true });

                        });
                    })
                }
            },
                function (tx, error) {
                    alert('查询失败: ' + error.message);
                });
        });
        $.tooltip('2秒后自动关闭', 2000, true);
        setTimeout(function () {
            $(".test").hDialog('close', { box: '#HBox' });
        }, 2000);
    }
});
function buy() {
   
    ExhibitionData.createDatabase();
    var eachHtml = "";
    $('#shop').html('');
    ExhibitionData.createDatabase();
    $.ajax({
        url: ExhibitionData.loadUrl.T_Bus_Exhibition,
        dataType: "JSON",
        async: false,
        cache: false,
        success: function (resp) {

            ExhibitionData.dataBase.transaction(function (tx) {
                tx.executeSql(
                "select * from exhibition where state=?", [1],
                function (tx, result) { //执行成功的回调函数
                    if (result.rows.length > 0) {
                        for (kid = 0; kid < result.rows.length; kid++) {
                            var id = parseInt(result.rows[kid].KeyId);
                            var queryResult = "";
                             queryResult = Enumerable.From(resp).Where("x=>x.KeyId==" + id).ToArray();

                            $.each(eval(queryResult), function (i, item) {

                                eachHtml = eachHtml + "<input type='text' name='Ex_Code' class='name' value='" + item.Code + "' hidden=hidden />";
                                eachHtml = eachHtml + "<h4><lable>商品名称：</lable><span>" + item.Name + "</span></h4>";
                                eachHtml = eachHtml + "	<h4><lable>商品单价：</lable><span>" + item.RentPrice + "</span></h4>";
                                eachHtml = eachHtml + "	<h4><lable>押金：</lable><span>" + item.Deposit + "</span></h4>";
                                eachHtml = eachHtml + "	<h4><lable>商品数量：</lable><span>" + result.rows[kid].count + "</span></h4>";
                                eachHtml = eachHtml + "<HR style='FILTER: alpha(opacity=100,finishopacity=0,style=1)' width='100%' color=#987cb9 SIZE=3>";
                                //eachHtml = eachHtml + "<h4 class='num'><lable class='fl'>商品数量：</lable><span class='subtract'>-</span><input value='1' name=count' class=count' readonly = 'true'/><span class='add' id='add'>+</span></h4></li>";
                                //eachHtml = eachHtml + "<li><a href='pro_detail.html?id=" + item.KeyId + "'><img src='" + item.PicUrl + "' /></a>";
                                //eachHtml = eachHtml + "<h4>" + item.Name + "</h4>";
                                //eachHtml = eachHtml + "<h6><span>RMB</span>" + item.RentPrice + "</h6></li>";
                                $('#shop').html(eachHtml);
                            });
                  
                         


                        }
                        scrollTo(0, 0);
                        $(".test").fbmodal({

                            okaybutton: true,
                            cancelbutton: true,
                            buttons: true,
                            opacity: 0.35,
                            fadeout: true,
                            overlayclose: true,
                            modaltop: "30%",
                            modalwidth: "400"
                        },
                              function (callback) {
                                  if (callback == 1) {
                                      if ($.trim($(".book .name").val()) == "" || $.trim($(".book .mobile").val()) == "" || $(".book .name").val() == "输入您的姓名" || $(".book .mobile").val() == "输入您的手机号" || $(".book .mobile").val() == "输入您的所在单位" || $(".book .mobile").val() == "输入您的所在单位" || $(".book .mobile").val() == "输入您的QQ方便联系" || $(".book .mobile").val() == "你要哪个展位呢？") {
                                          $.tooltip('亲 ，请将信息填写完整！', 2000, true);
                                          alert("亲 ，请将信息填写完整！");
                                          //new TipBox({ type: 'success', str: "亲 ，请将信息填写完整！", hasBtn: true });
                                          return false;
                                      } else {
                                          goods = [];
                                          $.ajax({
                                              url: ExhibitionData.loadUrl.T_Bus_Exhibition,
                                              dataType: "JSON",
                                              async: false,
                                              cache: false,
                                              success: function (resp) {
                                                  ExhibitionData.dataBase.transaction(function (tx) {
                                                      tx.executeSql(
                                                      "select * from exhibition where state=?", [1],
                                                      function (tx, result) { //执行成功的回调函数
                                                          if (result.rows.length > 0) {
                                                              for (kid = 0; kid < result.rows.length; kid++) {
                                                                  var id = parseInt(result.rows[kid].KeyId);
                                                                  var queryResult = Enumerable.From(resp).Where("x=>x.KeyId==" + id).ToArray();
                                                                  $.each(eval(queryResult), function (i, item) {
                                                                      goods.push({ "Ex_Code": item.Code, "Ex_Quantity": result.rows[kid].count });
                                                                  });
                                                              }
                                                              $.ajax({
                                                                  type: "POST",
                                                                  url: "../Handler.ashx",

                                                                  data: { Goods: JSON.stringify(goods), CustomerName: $("#CustomerName").val(), Contacts: $("#Contacts").val(), Phone: $("#Phone").val(), QQ: $("#QQ").val(), Position: $("#Position").val() },
                                                                  dataType: "JSON",
                                                                  success: function (resp) {
                                                                      if (resp.Success) {
                                                                          //new TipBox({ type: 'success', str: resp.msg, hasBtn: true });

                                                                          ExhibitionData.dataBase.transaction(function (tx) {
                                                                              tx.executeSql(
                                                                              "update exhibition set state = ?",
                                                                              [0],
                                                                              function (tx, result) {
                                                                              },
                                                                              function (tx, error) {
                                                                                  alert('更新失败: ' + error.message);
                                                                              });
                                                                          });
                                                                      }
                                                                      alert(resp.msg);
                                                                      window.location.reload();
                                                                  },
                                                                  error: function (XMLHttpRequest, textStatus, errorThrown) {
                                                                      alert("哎呀我起网络开小差了！去首页看看吧！");
                                                                      window.location.reload();
                                                                  }
                                                              });
                                                          }
                                                      }
                                                      ,
                                              function (tx, error) {
                                                  alert('查询失败: ' + error.message);
                                              });
                                                  });
                                              }
                                          });
                                      }
                                      //alert("你点了确定按钮");
                                  }
                                  if (callback == 2) {
                                      $('#shop').html("");
                                    //  alert("你点了取消按钮");
                                  }

                              });
                    } else {
                        alert("购物车空空，去首页看看吧！");
                        window.location.href = "/";
                    }
                    ;
                },
                function (tx, error) {
                    alert('查询失败: ' + error.message);
                });
            });

        },
        error: function (XMLHttpRequest, textStatus, errorThrown) {
        }
    });
 
};
    </script>

</body>
</html>
